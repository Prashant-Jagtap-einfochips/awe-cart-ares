function troubleStruct = FindRogueTalariaBlocks(rootFolder)
%FindRogueBlocks Searches for *.slx files finding link-destroyed Talaria
%blocks
%   Provide a root folder in which to search for files ending in .slx.
% This function will attempt to discover Talaria blocks which have somehow
% had their library link severed. The blocks must still have the correct
% mask type listed to be detected.
%    resultsStruct = FindRogueTalariaBlocks(rootFolder);
%
% See also: struct2table

if false == exist('writeChangesToFile','var')
    writeChangesToFile = false;
end

fprintf("Searching in folder %s for rogue Talaria blocks. " + ...
    "Library mapping based on Talaria V2200BD\n",rootFolder);
theMap = GetBlockDictionaryMap();

% Search for potential TuneVar-containing SLX files
filesystemSearchExpr = sprintf('%s/**/*.slx',rootFolder);
foundFiles = dir(filesystemSearchExpr);

troubleStruct = struct.empty;

% Loop through files and discover what they contain
for i=1:numel(foundFiles)
    aDirEntry = foundFiles(i);
    aFilename = fullfile(aDirEntry.folder,aDirEntry.name);
    fprintf('   %s...\n',aFilename);
    model = load_system(aFilename);

    % Search for all TuneVars, all variants, under masks, but not links
    F = Simulink.FindOptions(LookUnderMasks="All");
    blocks = Simulink.findBlocks(model,F);
    numBlocks = numel(blocks);
    foundCount = 0;
    for b=1:numBlocks
        aBlock = blocks(b);
        blockName = getfullname(aBlock);
        maskType = get(aBlock,'MaskType');
        refBlock = get(aBlock,'ReferenceBlock');
        if (isempty(maskType))
            continue;
        end
        if (theMap.isKey(maskType))
            correctRef = theMap(maskType);
            if (false == strcmp(refBlock,correctRef))
                troubleStruct(end+1).Block = blockName;
                troubleStruct(end).BadRef = refBlock;
                troubleStruct(end).CorrectRef = correctRef;
                fprintf("Rogue block '%s' should be %s, not %s\n", ...
                    blockName, ...
                    correctRef,refBlock);
            end
        end
    end
    close_system(model);
end
end % function

function theMap = GetBlockDictionaryMap()
theMap = dictionary( ...
    "Talaria Async Target Console"   , "FeaturePath/AsyncConsole"          , ...
    "Talaria Core Index"             , "FeaturePath/CoreIndex"             , ...
    "Talaria Handy Text File"        , "HandyTextFile/HandyTextFile"       , ...
    "Talaria Feature Path"           , "FeaturePath/FeaturePath"           , ...
    "Talaria Model External Inport"  , "EdgePorts/ModelExtIn"              , ...
    "Talaria Audio Statistics"       , "AudioStats/AudioStats"             , ...
    "Talaria Build-Time Configure…"  , "EdgePorts/InportBuildTime"         , ...
    "Talaria Model External Outport" , "EdgePorts/ModelExtOut"             , ...
    "Talaria Model Root Inport"      , "EdgePorts/ModelRootInport"         , ...
    "Talaria API Buffer"             , "TalariaApiBuffer/TalariaApiB…"     , ...
    "Talaria Model Root Outport"     , "EdgePorts/ModelRootOutport"        , ...
    "Talaria Feature Version"        , "FeatureVersion/FeatureVersion"     , ...
    "Talaria Compat Block"           , "CompatHash/CompatHash"             , ...
    "Talaria Initialization Trigg…"  , "ITC/ITC"                           , ...
    "Talaria Target State Variable"  , "StateVar/TargetStateVar"           , ...
    "Talaria State Variable"         , "StateVar/StateVar"                 , ...
    "Talaria Target State Probe"     , "TSP/TSP"                           , ...
    "Talaria Trivial Interpretation" , "StateVar/TrivialInterpretation"    , ...
    "Talaria Interpret Trigger"      , "StateVar/InterpretTrigger"         , ...
    "Talaria RTC Receive"            , "RTC/RTC"                           , ...
    "Talaria Trivial Tune TOP"       , "TuneVar/TuneTOP"                   , ...
    "Talaria Target Overlay Param…"  , "TOP/TOP"                           , ...
    "Talaria Trivial Translation"    , "TuneVar/TrivialTranslation"        , ...
    "Talaria Translate Trigger"      , "TuneVar/TranslateTrigger"          , ...
    "Talaria Tune Variable"          , "TuneVar/TuneVar"                   , ...
    "Talaria TSP Capture Control"    , "TSP/TspCaptureControl"             , ...
    "Talaria Captured Constant"      , "CapturedConstLib/CapturedConst"    , ...
    "Talaria Partition"              , "FeaturePath/Partition"              ...
    );
end
